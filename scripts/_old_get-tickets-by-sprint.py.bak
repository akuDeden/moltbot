#!/usr/bin/env python3
"""
Get tickets from database_dev filtered by sprint
Usage: python3 get-tickets-by-sprint.py [sprint_number]
Example: python3 get-tickets-by-sprint.py 2
"""
import sys
import json

try:
    from notion_client import Client
except ImportError:
    print("âŒ Error: notion-client not installed")
    sys.exit(1)

CREDENTIALS_FILE = "/Users/ahmadfaris/moltbot-workspace/notion-credentials.json"

def load_credentials():
    try:
        with open(CREDENTIALS_FILE, 'r') as f:
            return json.load(f)
    except FileNotFoundError:
        print(f"âŒ Error: {CREDENTIALS_FILE} not found")
        sys.exit(1)

def get_tickets(notion, database_id, sprint_database_id, sprint_filter=None):
    """Get tickets from database_dev, optionally filtered by sprint"""
    try:
        # First, if sprint filter provided, get the Sprint UUID
        sprint_uuid = None
        if sprint_filter:
            sprint_result = notion.data_sources.query(data_source_id=sprint_database_id)
            for sprint_page in sprint_result.get("results", []):
                props = sprint_page.get("properties", {})
                for key in props.keys():
                    prop_data = props[key]
                    if prop_data.get("type") == "title":
                        title_list = prop_data.get("title", [])
                        if title_list:
                            title = title_list[0].get("plain_text", "")
                            # Match "Sprint 2" in title
                            if f"sprint {sprint_filter}" in title.lower() and "â€“" in title:
                                sprint_uuid = sprint_page.get("id")
                                print(f"ğŸ” Found sprint: {title}")
                                break
                if sprint_uuid:
                    break
        
        # Query all tickets
        response = notion.data_sources.query(data_source_id=database_id)
        
        tickets = []
        for page in response.get("results", []):
            page_id = page["id"]
            url = page["url"]
            
            # Get title
            title = "Untitled"
            props = page.get("properties", {})
            for key in props.keys():
                prop_data = props[key]
                if prop_data.get("type") == "title":
                    title_list = prop_data.get("title", [])
                    if title_list:
                        title = title_list[0].get("plain_text", "Untitled")
                    break
            
            # Get sprint relation IDs
            sprint_ids = []
            if "Sprint" in props:
                sprint_rel = props["Sprint"].get("relation", [])
                sprint_ids = [rel["id"] for rel in sprint_rel]
            
            # If filtering by sprint, check if this ticket belongs to it
            if sprint_uuid:
                if sprint_uuid not in sprint_ids:
                    continue  # Skip this ticket
            
            sprint_info = f"{len(sprint_ids)} sprint(s)" if sprint_ids else "No Sprint"
            
            tickets.append({
                "title": title,
                "url": url,
                "id": page_id,
                "sprint": sprint_info
            })
        
        return tickets
    except Exception as e:
        print(f"âŒ Error querying database: {str(e)}")
        sys.exit(1)

def main():
    # Load credentials
    creds = load_credentials()
    notion_token = creds.get("notion_token")
    dev_db_id = creds.get("database_dev")
    sprint_db_id = creds.get("sprint_database_id")
    
    if not notion_token or not dev_db_id or not sprint_db_id:
        print("âŒ Error: credentials missing")
        sys.exit(1)
    
    # Initialize Notion client
    notion = Client(auth=notion_token)
    
    # Get sprint filter if provided
    sprint_filter = None
    if len(sys.argv) > 1:
        sprint_num = sys.argv[1]
        sprint_filter = sprint_num
    
    # Get tickets
    tickets = get_tickets(notion, dev_db_id, sprint_db_id, sprint_filter)
    
    if not tickets:
        if sprint_filter:
            print(f"âŒ No tickets found in Sprint {sprint_filter}")
        else:
            print("âŒ No tickets found")
        sys.exit(1)
    
    # Display results
    if sprint_filter:
        print(f"ğŸ“‹ Tickets in Sprint {sprint_filter}:")
    else:
        print("ğŸ“‹ All tickets:")
    
    for i, ticket in enumerate(tickets, 1):
        print(f"{i}. {ticket['title']}")
        print(f"   ğŸ”— {ticket['url']}")

if __name__ == "__main__":
    main()
